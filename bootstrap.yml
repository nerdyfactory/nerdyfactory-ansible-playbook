---
- hosts: "{{ hosts }}"
  remote_user: '{{ user }}'
  become: yes
  become_user: root

  vars:
    - locale: 'ko_KR.UTF-8'
    - language: 'en_US:en'
    - timezone: 'Asia/Seoul'
    - admin_user: 'webadm'

  tasks:
    - name: create admin group
      group: name={{ item }}
      with_items: 
      - admin
      - www-data
    - name: create admin group
      group: name=admin
    - name: add admin user
      user: name={{admin_user}} state=present shell=/bin/bash groups=www-data,admin
    - name: copy /etc/sudoers
      command: cp -f /etc/sudoers /etc/sudoers.tmp
    - name: backup sudoers file
      command: cp -f /etc/sudoers /etc/sudoers.bak
    - name: add admin group to sudoers
      lineinfile: "dest=/etc/sudoers.tmp line='admin' state=present"
    - name: add admin group to sudo nopasswd
      lineinfile: "dest=/etc/sudoers.tmp state=present regexp=^admin line='%admin ALL=(ALL) NOPASSWD: ALL'"
    - name: add vagrant group to sudoers
      lineinfile: "dest=/etc/sudoers.tmp line='vagrant' state=present"
      when: user == "vagrant"
    - name: add admin group to sudo nopasswd
      lineinfile: "dest=/etc/sudoers.tmp state=present regexp=^vagrant line='%vagrant ALL=(ALL) NOPASSWD: ALL'"
      when: user == "vagrant"
    - name: add ssh-agent to sudo
      lineinfile: dest=/etc/sudoers.tmp state=present regexp="^Defaults env_keep\+\=SSH_AUTH_SOCK" line="Defaults env_keep+=SSH_AUTH_SOCK"
    - name: final sudoers check
      raw: "visudo -q -c -f /etc/sudoers.tmp && cp -f /etc/sudoers.tmp /etc/sudoers"
    - name: add our ssh public keys
      authorized_key: user={{admin_user}} key="{{ item  }}"
      with_file:
        - "pub_keys/jonghun.pub"
        - "pub_keys/vinay.pub"
      tags: pub_keys
    - name: Disallow password authentication
      action: lineinfile dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
      notify: restart ssh
    - name: Disallow root SSH access
      action: lineinfile dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
      notify: restart ssh
    - name: Delete /etc/sudoers.d/ files
      command: rm -f /etc/sudoers.d/*
    - name: Install packages
      action: apt pkg=ufw state=installed
    - name: Setup ufw 22/tcp
      command: ufw allow 22/tcp
    - name: Setup ufw 80/tcp
      command: ufw allow 80/tcp
    - name: Setup ufw 443/tcp
      action: shell ufw allow 443/tcp
    - name: Enable ufw
      command: echo 'y' | ufw enable
    - name: Delete root password
      command: passwd -d root
    - name: Generate locale
      command: /usr/sbin/locale-gen {{ locale }}
    - name: Set locale
      command: /usr/sbin/update-locale LANG={{ locale }} LC_ALL={{ locale }} LANGUAGE={{ language }}
    - name: locale setting
      command: "localectl set-locale LANG={{ locale }}"
    - name: Set /etc/localtime
      command: /bin/cp /usr/share/zoneinfo/{{ timezone }} /etc/localtime
    - name: Set timezone (/etc/timezone)
      copy: content={{ timezone }} dest=/etc/timezone
      notify: update tzdata
    - name: Install ntp packages
      package: name=ntp state=latest update_cache=yes

  handlers:
    - name: restart ssh
      action: service name=ssh state=restarted
    - name: update tzdata
      command: /usr/sbin/dpkg-reconfigure --frontend noninteractive tzdata
